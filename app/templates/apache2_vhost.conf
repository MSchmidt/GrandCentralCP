# Created <%= Time.now %>
# This file was created by GrandCentralCP
# Do NOT edit this file manually
# all changes will be overwritten by GCCP

<VirtualHost *:80>
  ServerName <%= servername %>
  ServerAlias <%= serveralias %>
  ServerAdmin <%= email %>
  DocumentRoot /var/www<%= folder %><%= '/current/public' if rails %>
  <Directory /var/www<%= folder %><%= '/current/public' if rails %>>
    Options Indexes FollowSymLinks MultiViews
    AllowOverride None
    Order allow,deny
    allow from all
  </Directory>
  
  <% if rails %>
    # Loadbalancer
    # Verteilen der Anfragen auf die drei Mongrel-Server
    <Proxy balancer:/<%= folder %>_cluster>
      BalancerMember http://127.0.0.1:8020
      BalancerMember http://127.0.0.1:8021
      BalancerMember http://127.0.0.1:8022
    </Proxy>

    RewriteEngine On

    # Falls Datei maintenance.html vorhanden ist, alle Anfragen an diese Datei umleiten
    RewriteCond %{DOCUMENT_ROOT}/system/maintenance.html -f
    RewriteCond %{SCRIPT_FILENAME} !maintenance.html
    RewriteRule ^.*$ /system/maintenance.html [L]

    # Liefere die index.html aus, falls vorhanden, wenn nur die Domain ohne Pfad aufgerufen wird.
    RewriteRule ^/$ /index.html [QSA]

    # Liefere HTML-Cache-Dateien direkt aus
    RewriteRule ^([^.]+)$ $1.html [QSA]
    
    # Alle nicht-statischen Anfragen, werden an den Cluster geschickt
    RewriteCond %{DOCUMENT_ROOT}/%{REQUEST_FILENAME} !-f
    RewriteRule ^/(.*)$ balancer:/<%= folder %>_cluster%{REQUEST_URI} [P,QSA,L]

    # Komprimierung von HTML-, Text- und XML-Dateien.
    AddOutputFilterByType DEFLATE text/html text/plain text/xml
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
  <% end %>
  
  <%= 'php_admin_flag engine off' unless php %>
  ErrorLog "/var/customers/logs/<%= servername %>-error.log"
  CustomLog "/var/customers/logs/<%= servername %>-access.log" combined
</VirtualHost>

